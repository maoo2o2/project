var Jn=Object.defineProperty;var en=t=>{throw TypeError(t)};var Qn=(t,e,n)=>e in t?Jn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var F=(t,e,n)=>Qn(t,typeof e!="symbol"?e+"":e,n),tn=(t,e,n)=>e.has(t)||en("Cannot "+n);var v=(t,e,n)=>(tn(t,e,"read from private field"),n?n.call(t):e.get(t)),de=(t,e,n)=>e.has(t)?en("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),Ue=(t,e,n,o)=>(tn(t,e,"write to private field"),o?o.call(t,n):e.set(t,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();var _;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(_||(_={}));const eo=(()=>{let t=0;return()=>t++})(),to=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),no=new Error("called FFmpeg.terminate()");var Y,he,oe,De,_e,St,B;class oo{constructor(){de(this,Y,null);de(this,he,{});de(this,oe,{});de(this,De,[]);de(this,_e,[]);F(this,"loaded",!1);de(this,St,()=>{v(this,Y)&&(v(this,Y).onmessage=({data:{id:e,type:n,data:o}})=>{switch(n){case _.LOAD:this.loaded=!0,v(this,he)[e](o);break;case _.MOUNT:case _.UNMOUNT:case _.EXEC:case _.FFPROBE:case _.WRITE_FILE:case _.READ_FILE:case _.DELETE_FILE:case _.RENAME:case _.CREATE_DIR:case _.LIST_DIR:case _.DELETE_DIR:v(this,he)[e](o);break;case _.LOG:v(this,De).forEach(r=>r(o));break;case _.PROGRESS:v(this,_e).forEach(r=>r(o));break;case _.ERROR:v(this,oe)[e](o);break}delete v(this,he)[e],delete v(this,oe)[e]})});de(this,B,({type:e,data:n},o=[],r)=>v(this,Y)?new Promise((i,a)=>{const l=eo();v(this,Y)&&v(this,Y).postMessage({id:l,type:e,data:n},o),v(this,he)[l]=i,v(this,oe)[l]=a,r==null||r.addEventListener("abort",()=>{a(new DOMException(`Message # ${l} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(to));F(this,"load",({classWorkerURL:e,...n}={},{signal:o}={})=>(v(this,Y)||(Ue(this,Y,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/project/3clip/assets/worker-BAOIWoxA.js",import.meta.url),{type:"module"})),v(this,St).call(this)),v(this,B).call(this,{type:_.LOAD,data:n},void 0,o)));F(this,"exec",(e,n=-1,{signal:o}={})=>v(this,B).call(this,{type:_.EXEC,data:{args:e,timeout:n}},void 0,o));F(this,"ffprobe",(e,n=-1,{signal:o}={})=>v(this,B).call(this,{type:_.FFPROBE,data:{args:e,timeout:n}},void 0,o));F(this,"terminate",()=>{const e=Object.keys(v(this,oe));for(const n of e)v(this,oe)[n](no),delete v(this,oe)[n],delete v(this,he)[n];v(this,Y)&&(v(this,Y).terminate(),Ue(this,Y,null),this.loaded=!1)});F(this,"writeFile",(e,n,{signal:o}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),v(this,B).call(this,{type:_.WRITE_FILE,data:{path:e,data:n}},r,o)});F(this,"mount",(e,n,o)=>{const r=[];return v(this,B).call(this,{type:_.MOUNT,data:{fsType:e,options:n,mountPoint:o}},r)});F(this,"unmount",e=>{const n=[];return v(this,B).call(this,{type:_.UNMOUNT,data:{mountPoint:e}},n)});F(this,"readFile",(e,n="binary",{signal:o}={})=>v(this,B).call(this,{type:_.READ_FILE,data:{path:e,encoding:n}},void 0,o));F(this,"deleteFile",(e,{signal:n}={})=>v(this,B).call(this,{type:_.DELETE_FILE,data:{path:e}},void 0,n));F(this,"rename",(e,n,{signal:o}={})=>v(this,B).call(this,{type:_.RENAME,data:{oldPath:e,newPath:n}},void 0,o));F(this,"createDir",(e,{signal:n}={})=>v(this,B).call(this,{type:_.CREATE_DIR,data:{path:e}},void 0,n));F(this,"listDir",(e,{signal:n}={})=>v(this,B).call(this,{type:_.LIST_DIR,data:{path:e}},void 0,n));F(this,"deleteDir",(e,{signal:n}={})=>v(this,B).call(this,{type:_.DELETE_DIR,data:{path:e}},void 0,n))}on(e,n){e==="log"?v(this,De).push(n):e==="progress"&&v(this,_e).push(n)}off(e,n){e==="log"?Ue(this,De,v(this,De).filter(o=>o!==n)):e==="progress"&&Ue(this,_e,v(this,_e).filter(o=>o!==n))}}Y=new WeakMap,he=new WeakMap,oe=new WeakMap,De=new WeakMap,_e=new WeakMap,St=new WeakMap,B=new WeakMap;var nn;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(nn||(nn={}));const ro=new Error("failed to get response body reader"),io=new Error("failed to complete download"),ao="Content-Length",lo=t=>new Promise((e,n)=>{const o=new FileReader;o.onload=()=>{const{result:r}=o;r instanceof ArrayBuffer?e(new Uint8Array(r)):e(new Uint8Array)},o.onerror=r=>{var i,a;n(Error(`File could not be read! Code=${((a=(i=r==null?void 0:r.target)==null?void 0:i.error)==null?void 0:a.code)||-1}`))},o.readAsArrayBuffer(t)}),ut=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await lo(t);else return new Uint8Array;return new Uint8Array(e)},so=async(t,e)=>{var r;const n=await fetch(t);let o;try{const i=parseInt(n.headers.get(ao)||"-1"),a=(r=n.body)==null?void 0:r.getReader();if(!a)throw ro;const l=[];let s=0;for(;;){const{done:u,value:g}=await a.read(),b=g?g.length:0;if(u){if(i!=-1&&i!==s)throw io;e&&e({url:t,total:i,received:s,delta:b,done:u});break}l.push(g),s+=b,e&&e({url:t,total:i,received:s,delta:b,done:u})}const c=new Uint8Array(s);let f=0;for(const u of l)c.set(u,f),f+=u.length;o=c.buffer}catch(i){console.log("failed to send download progress event: ",i),o=await n.arrayBuffer()}return o},ke=async(t,e,n=!1,o)=>{const r=n?await so(t,o):await(await fetch(t)).arrayBuffer(),i=new Blob([r],{type:e});return URL.createObjectURL(i)};let S=null,Bt=!1;async function co(){if(Bt)return;if(S=new oo,typeof SharedArrayBuffer<"u"){const e="https://unpkg.com/@ffmpeg/core-mt@0.12.6/dist/esm";await S.load({coreURL:await ke(`${e}/ffmpeg-core.js`,"text/javascript"),wasmURL:await ke(`${e}/ffmpeg-core.wasm`,"application/wasm"),workerURL:await ke(`${e}/ffmpeg-core.worker.js`,"text/javascript")})}else{const e="https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm";await S.load({coreURL:await ke(`${e}/ffmpeg-core.js`,"text/javascript"),wasmURL:await ke(`${e}/ffmpeg-core.wasm`,"application/wasm")})}Bt=!0}const uo=["zscale=t=linear:npl=100","format=gbrpf32le","zscale=p=bt709","tonemap=tonemap=hable:desat=0","zscale=t=bt709:m=bt709:r=tv","format=yuv420p","fps=30","setpts=PTS-STARTPTS"].join(","),fo="format=yuv420p,fps=30,setpts=PTS-STARTPTS";function ho(t){return po(t)}async function po(t){try{const n=await t.slice(0,65536).arrayBuffer(),o=new Uint8Array(n),r=new TextDecoder("latin1").decode(o);return!!(r.includes("arib")||r.includes("smpt")||r.includes("bt2020"))}catch{return!1}}async function mo(t){await Ht();const e=`input_${Date.now()}.${bn(t.name,"mp4")}`,n=`trimmed_${Date.now()}.mp4`,r=await ho(t)?uo:fo;await S.writeFile(e,await ut(t)),await S.exec(["-i",e,"-t","3","-c:v","libx264","-crf","26","-preset","ultrafast","-vf",r,"-colorspace","bt709","-color_primaries","bt709","-color_trc","bt709","-pix_fmt","yuv420p","-c:a","aac","-ar","44100","-af","aresample=async=1","-movflags","+faststart",n]);const i=await S.readFile(n);return await S.deleteFile(e),await S.deleteFile(n),new Blob([i.buffer],{type:"video/mp4"})}async function go(t){await Ht();const e=bn(t.name,"jpg"),n=`img_${Date.now()}.${e}`,o=`imgclip_${Date.now()}.mp4`;await S.writeFile(n,await ut(t)),await S.exec(["-loop","1","-i",n,"-t","3","-vf","scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,format=yuv420p,fps=30,setpts=PTS-STARTPTS","-c:v","libx264","-crf","26","-preset","ultrafast","-pix_fmt","yuv420p","-colorspace","bt709","-color_primaries","bt709","-color_trc","bt709","-movflags","+faststart",o]);const r=await S.readFile(o);return await S.deleteFile(n),await S.deleteFile(o),new Blob([r.buffer],{type:"video/mp4"})}async function vn(t,e=null,n){await Ht();const o=Date.now(),r=[];for(let s=0;s<t.length;s++){const c=`clip_${o}_${s}.mp4`;await S.writeFile(c,await ut(t[s])),r.push(c),n==null||n(Math.round(s/t.length*50))}const i=`concat_${o}.txt`;await S.writeFile(i,r.map(s=>`file '${s}'`).join(`
`));const a=`merged_${o}.mp4`;if(e){const s=`video_only_${o}.mp4`;await S.exec(["-f","concat","-safe","0","-i",i,"-c","copy",s]);const c=`bgm_${o}.mp3`,f=await fetch(e).then(b=>b.blob());await S.writeFile(c,await ut(f));const u=t.length*3,g=Math.max(0,u-1.5);await S.exec(["-i",s,"-ss","0","-i",c,"-map","0:v:0","-map","1:a:0","-c:v","copy","-c:a","aac","-ar","44100","-t",String(u),"-af",`afade=t=out:st=${g}:d=1.5`,"-movflags","+faststart",a]),await S.deleteFile(s),await S.deleteFile(c)}else await S.exec(["-f","concat","-safe","0","-i",i,"-c:v","copy","-c:a","aac","-ar","44100","-movflags","+faststart",a]);n==null||n(95);const l=await S.readFile(a);for(const s of r)await S.deleteFile(s);return await S.deleteFile(i),await S.deleteFile(a),n==null||n(100),new Blob([l.buffer],{type:"video/mp4"})}async function Ht(){if(!Bt)throw new Error("FFmpeg not loaded. Call loadFFmpeg() first.")}function bn(t,e="mp4"){const n=t==null?void 0:t.split(".");return(n==null?void 0:n.length)>1?n[n.length-1].toLowerCase():e}/**!
 * Sortable 1.15.7
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */function vo(t,e,n){return(e=Eo(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function ae(){return ae=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)({}).hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},ae.apply(null,arguments)}function on(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,o)}return n}function ee(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?on(Object(n),!0).forEach(function(o){vo(t,o,n[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):on(Object(n)).forEach(function(o){Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(n,o))})}return t}function bo(t,e){if(t==null)return{};var n,o,r=yo(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(o=0;o<i.length;o++)n=i[o],e.indexOf(n)===-1&&{}.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}function yo(t,e){if(t==null)return{};var n={};for(var o in t)if({}.hasOwnProperty.call(t,o)){if(e.indexOf(o)!==-1)continue;n[o]=t[o]}return n}function wo(t,e){if(typeof t!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var o=n.call(t,e);if(typeof o!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Eo(t){var e=wo(t,"string");return typeof e=="symbol"?e:e+""}function Mt(t){"@babel/helpers - typeof";return Mt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Mt(t)}var Do="1.15.7";function ie(t){if(typeof window<"u"&&window.navigator)return!!navigator.userAgent.match(t)}var le=ie(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),Qe=ie(/Edge/i),rn=ie(/firefox/i),He=ie(/safari/i)&&!ie(/chrome/i)&&!ie(/android/i),Gt=ie(/iP(ad|od|hone)/i),yn=ie(/chrome/i)&&ie(/android/i),wn={capture:!1,passive:!1};function w(t,e,n){t.addEventListener(e,n,!le&&wn)}function y(t,e,n){t.removeEventListener(e,n,!le&&wn)}function ft(t,e){if(e){if(e[0]===">"&&(e=e.substring(1)),t)try{if(t.matches)return t.matches(e);if(t.msMatchesSelector)return t.msMatchesSelector(e);if(t.webkitMatchesSelector)return t.webkitMatchesSelector(e)}catch{return!1}return!1}}function En(t){return t.host&&t!==document&&t.host.nodeType&&t.host!==t?t.host:t.parentNode}function V(t,e,n,o){if(t){n=n||document;do{if(e!=null&&(e[0]===">"?t.parentNode===n&&ft(t,e):ft(t,e))||o&&t===n)return t;if(t===n)break}while(t=En(t))}return null}var an=/\s+/g;function X(t,e,n){if(t&&e)if(t.classList)t.classList[n?"add":"remove"](e);else{var o=(" "+t.className+" ").replace(an," ").replace(" "+e+" "," ");t.className=(o+(n?" "+e:"")).replace(an," ")}}function h(t,e,n){var o=t&&t.style;if(o){if(n===void 0)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(t,""):t.currentStyle&&(n=t.currentStyle),e===void 0?n:n[e];!(e in o)&&e.indexOf("webkit")===-1&&(e="-webkit-"+e),o[e]=n+(typeof n=="string"?"":"px")}}function Le(t,e){var n="";if(typeof t=="string")n=t;else do{var o=h(t,"transform");o&&o!=="none"&&(n=o+" "+n)}while(!e&&(t=t.parentNode));var r=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return r&&new r(n)}function Dn(t,e,n){if(t){var o=t.getElementsByTagName(e),r=0,i=o.length;if(n)for(;r<i;r++)n(o[r],r);return o}return[]}function Q(){var t=document.scrollingElement;return t||document.documentElement}function C(t,e,n,o,r){if(!(!t.getBoundingClientRect&&t!==window)){var i,a,l,s,c,f,u;if(t!==window&&t.parentNode&&t!==Q()?(i=t.getBoundingClientRect(),a=i.top,l=i.left,s=i.bottom,c=i.right,f=i.height,u=i.width):(a=0,l=0,s=window.innerHeight,c=window.innerWidth,f=window.innerHeight,u=window.innerWidth),(e||n)&&t!==window&&(r=r||t.parentNode,!le))do if(r&&r.getBoundingClientRect&&(h(r,"transform")!=="none"||n&&h(r,"position")!=="static")){var g=r.getBoundingClientRect();a-=g.top+parseInt(h(r,"border-top-width")),l-=g.left+parseInt(h(r,"border-left-width")),s=a+i.height,c=l+i.width;break}while(r=r.parentNode);if(o&&t!==window){var b=Le(r||t),E=b&&b.a,D=b&&b.d;b&&(a/=D,l/=E,u/=E,f/=D,s=a+f,c=l+u)}return{top:a,left:l,bottom:s,right:c,width:u,height:f}}}function ln(t,e,n){for(var o=pe(t,!0),r=C(t)[e];o;){var i=C(o)[n],a=void 0;if(a=r>=i,!a)return o;if(o===Q())break;o=pe(o,!1)}return!1}function Ae(t,e,n,o){for(var r=0,i=0,a=t.children;i<a.length;){if(a[i].style.display!=="none"&&a[i]!==p.ghost&&(o||a[i]!==p.dragged)&&V(a[i],n.draggable,t,!1)){if(r===e)return a[i];r++}i++}return null}function zt(t,e){for(var n=t.lastElementChild;n&&(n===p.ghost||h(n,"display")==="none"||e&&!ft(n,e));)n=n.previousElementSibling;return n||null}function H(t,e){var n=0;if(!t||!t.parentNode)return-1;for(;t=t.previousElementSibling;)t.nodeName.toUpperCase()!=="TEMPLATE"&&t!==p.clone&&(!e||ft(t,e))&&n++;return n}function sn(t){var e=0,n=0,o=Q();if(t)do{var r=Le(t),i=r.a,a=r.d;e+=t.scrollLeft*i,n+=t.scrollTop*a}while(t!==o&&(t=t.parentNode));return[e,n]}function _o(t,e){for(var n in t)if(t.hasOwnProperty(n)){for(var o in e)if(e.hasOwnProperty(o)&&e[o]===t[n][o])return Number(n)}return-1}function pe(t,e){if(!t||!t.getBoundingClientRect)return Q();var n=t,o=!1;do if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var r=h(n);if(n.clientWidth<n.scrollWidth&&(r.overflowX=="auto"||r.overflowX=="scroll")||n.clientHeight<n.scrollHeight&&(r.overflowY=="auto"||r.overflowY=="scroll")){if(!n.getBoundingClientRect||n===document.body)return Q();if(o||e)return n;o=!0}}while(n=n.parentNode);return Q()}function So(t,e){if(t&&e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function xt(t,e){return Math.round(t.top)===Math.round(e.top)&&Math.round(t.left)===Math.round(e.left)&&Math.round(t.height)===Math.round(e.height)&&Math.round(t.width)===Math.round(e.width)}var Ge;function _n(t,e){return function(){if(!Ge){var n=arguments,o=this;n.length===1?t.call(o,n[0]):t.apply(o,n),Ge=setTimeout(function(){Ge=void 0},e)}}}function To(){clearTimeout(Ge),Ge=void 0}function Sn(t,e,n){t.scrollLeft+=e,t.scrollTop+=n}function Tn(t){var e=window.Polymer,n=window.jQuery||window.Zepto;return e&&e.dom?e.dom(t).cloneNode(!0):n?n(t).clone(!0)[0]:t.cloneNode(!0)}function In(t,e,n){var o={};return Array.from(t.children).forEach(function(r){var i,a,l,s;if(!(!V(r,e.draggable,t,!1)||r.animated||r===n)){var c=C(r);o.left=Math.min((i=o.left)!==null&&i!==void 0?i:1/0,c.left),o.top=Math.min((a=o.top)!==null&&a!==void 0?a:1/0,c.top),o.right=Math.max((l=o.right)!==null&&l!==void 0?l:-1/0,c.right),o.bottom=Math.max((s=o.bottom)!==null&&s!==void 0?s:-1/0,c.bottom)}}),o.width=o.right-o.left,o.height=o.bottom-o.top,o.x=o.left,o.y=o.top,o}var U="Sortable"+new Date().getTime();function Io(){var t=[],e;return{captureAnimationState:function(){if(t=[],!!this.options.animation){var o=[].slice.call(this.el.children);o.forEach(function(r){if(!(h(r,"display")==="none"||r===p.ghost)){t.push({target:r,rect:C(r)});var i=ee({},t[t.length-1].rect);if(r.thisAnimationDuration){var a=Le(r,!0);a&&(i.top-=a.f,i.left-=a.e)}r.fromRect=i}})}},addAnimationState:function(o){t.push(o)},removeAnimationState:function(o){t.splice(_o(t,{target:o}),1)},animateAll:function(o){var r=this;if(!this.options.animation){clearTimeout(e),typeof o=="function"&&o();return}var i=!1,a=0;t.forEach(function(l){var s=0,c=l.target,f=c.fromRect,u=C(c),g=c.prevFromRect,b=c.prevToRect,E=l.rect,D=Le(c,!0);D&&(u.top-=D.f,u.left-=D.e),c.toRect=u,c.thisAnimationDuration&&xt(g,u)&&!xt(f,u)&&(E.top-u.top)/(E.left-u.left)===(f.top-u.top)/(f.left-u.left)&&(s=Oo(E,g,b,r.options)),xt(u,f)||(c.prevFromRect=f,c.prevToRect=u,s||(s=r.options.animation),r.animate(c,E,u,s)),s&&(i=!0,a=Math.max(a,s),clearTimeout(c.animationResetTimer),c.animationResetTimer=setTimeout(function(){c.animationTime=0,c.prevFromRect=null,c.fromRect=null,c.prevToRect=null,c.thisAnimationDuration=null},s),c.thisAnimationDuration=s)}),clearTimeout(e),i?e=setTimeout(function(){typeof o=="function"&&o()},a):typeof o=="function"&&o(),t=[]},animate:function(o,r,i,a){if(a){h(o,"transition",""),h(o,"transform","");var l=Le(this.el),s=l&&l.a,c=l&&l.d,f=(r.left-i.left)/(s||1),u=(r.top-i.top)/(c||1);o.animatingX=!!f,o.animatingY=!!u,h(o,"transform","translate3d("+f+"px,"+u+"px,0)"),this.forRepaintDummy=xo(o),h(o,"transition","transform "+a+"ms"+(this.options.easing?" "+this.options.easing:"")),h(o,"transform","translate3d(0,0,0)"),typeof o.animated=="number"&&clearTimeout(o.animated),o.animated=setTimeout(function(){h(o,"transition",""),h(o,"transform",""),o.animated=!1,o.animatingX=!1,o.animatingY=!1},a)}}}}function xo(t){return t.offsetWidth}function Oo(t,e,n,o){return Math.sqrt(Math.pow(e.top-t.top,2)+Math.pow(e.left-t.left,2))/Math.sqrt(Math.pow(e.top-n.top,2)+Math.pow(e.left-n.left,2))*o.animation}var Se=[],Ot={initializeByDefault:!0},et={mount:function(e){for(var n in Ot)Ot.hasOwnProperty(n)&&!(n in e)&&(e[n]=Ot[n]);Se.forEach(function(o){if(o.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),Se.push(e)},pluginEvent:function(e,n,o){var r=this;this.eventCanceled=!1,o.cancel=function(){r.eventCanceled=!0};var i=e+"Global";Se.forEach(function(a){n[a.pluginName]&&(n[a.pluginName][i]&&n[a.pluginName][i](ee({sortable:n},o)),n.options[a.pluginName]&&n[a.pluginName][e]&&n[a.pluginName][e](ee({sortable:n},o)))})},initializePlugins:function(e,n,o,r){Se.forEach(function(l){var s=l.pluginName;if(!(!e.options[s]&&!l.initializeByDefault)){var c=new l(e,n,e.options);c.sortable=e,c.options=e.options,e[s]=c,ae(o,c.defaults)}});for(var i in e.options)if(e.options.hasOwnProperty(i)){var a=this.modifyOption(e,i,e.options[i]);typeof a<"u"&&(e.options[i]=a)}},getEventProperties:function(e,n){var o={};return Se.forEach(function(r){typeof r.eventProperties=="function"&&ae(o,r.eventProperties.call(n[r.pluginName],e))}),o},modifyOption:function(e,n,o){var r;return Se.forEach(function(i){e[i.pluginName]&&i.optionListeners&&typeof i.optionListeners[n]=="function"&&(r=i.optionListeners[n].call(e[i.pluginName],o))}),r}};function Co(t){var e=t.sortable,n=t.rootEl,o=t.name,r=t.targetEl,i=t.cloneEl,a=t.toEl,l=t.fromEl,s=t.oldIndex,c=t.newIndex,f=t.oldDraggableIndex,u=t.newDraggableIndex,g=t.originalEvent,b=t.putSortable,E=t.extraEventProperties;if(e=e||n&&n[U],!!e){var D,G=e.options,te="on"+o.charAt(0).toUpperCase()+o.substr(1);window.CustomEvent&&!le&&!Qe?D=new CustomEvent(o,{bubbles:!0,cancelable:!0}):(D=document.createEvent("Event"),D.initEvent(o,!0,!0)),D.to=a||n,D.from=l||n,D.item=r||n,D.clone=i,D.oldIndex=s,D.newIndex=c,D.oldDraggableIndex=f,D.newDraggableIndex=u,D.originalEvent=g,D.pullMode=b?b.lastPutMode:void 0;var P=ee(ee({},E),et.getEventProperties(o,e));for(var z in P)D[z]=P[z];n&&n.dispatchEvent(D),G[te]&&G[te].call(e,D)}}var Ro=["evt"],M=function(e,n){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=o.evt,i=bo(o,Ro);et.pluginEvent.bind(p)(e,n,ee({dragEl:d,parentEl:x,ghostEl:m,rootEl:T,nextEl:Ee,lastDownEl:lt,cloneEl:I,cloneHidden:fe,dragStarted:Xe,putSortable:L,activeSortable:p.active,originalEvent:r,oldIndex:Re,oldDraggableIndex:ze,newIndex:W,newDraggableIndex:ue,hideGhostForTarget:Rn,unhideGhostForTarget:Ln,cloneNowHidden:function(){fe=!0},cloneNowShown:function(){fe=!1},dispatchSortableEvent:function(l){$({sortable:n,name:l,originalEvent:r})}},i))};function $(t){Co(ee({putSortable:L,cloneEl:I,targetEl:d,rootEl:T,oldIndex:Re,oldDraggableIndex:ze,newIndex:W,newDraggableIndex:ue},t))}var d,x,m,T,Ee,lt,I,fe,Re,W,ze,ue,nt,L,Oe=!1,ht=!1,pt=[],be,q,Ct,Rt,cn,dn,Xe,Te,qe,Ve=!1,ot=!1,st,A,Lt=[],Ut=!1,mt=[],Tt=typeof document<"u",rt=Gt,un=Qe||le?"cssFloat":"float",Lo=Tt&&!yn&&!Gt&&"draggable"in document.createElement("div"),xn=function(){if(Tt){if(le)return!1;var t=document.createElement("x");return t.style.cssText="pointer-events:auto",t.style.pointerEvents==="auto"}}(),On=function(e,n){var o=h(e),r=parseInt(o.width)-parseInt(o.paddingLeft)-parseInt(o.paddingRight)-parseInt(o.borderLeftWidth)-parseInt(o.borderRightWidth),i=Ae(e,0,n),a=Ae(e,1,n),l=i&&h(i),s=a&&h(a),c=l&&parseInt(l.marginLeft)+parseInt(l.marginRight)+C(i).width,f=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+C(a).width;if(o.display==="flex")return o.flexDirection==="column"||o.flexDirection==="column-reverse"?"vertical":"horizontal";if(o.display==="grid")return o.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(i&&l.float&&l.float!=="none"){var u=l.float==="left"?"left":"right";return a&&(s.clear==="both"||s.clear===u)?"vertical":"horizontal"}return i&&(l.display==="block"||l.display==="flex"||l.display==="table"||l.display==="grid"||c>=r&&o[un]==="none"||a&&o[un]==="none"&&c+f>r)?"vertical":"horizontal"},Ao=function(e,n,o){var r=o?e.left:e.top,i=o?e.right:e.bottom,a=o?e.width:e.height,l=o?n.left:n.top,s=o?n.right:n.bottom,c=o?n.width:n.height;return r===l||i===s||r+a/2===l+c/2},No=function(e,n){var o;return pt.some(function(r){var i=r[U].options.emptyInsertThreshold;if(!(!i||zt(r))){var a=C(r),l=e>=a.left-i&&e<=a.right+i,s=n>=a.top-i&&n<=a.bottom+i;if(l&&s)return o=r}}),o},Cn=function(e){function n(i,a){return function(l,s,c,f){var u=l.options.group.name&&s.options.group.name&&l.options.group.name===s.options.group.name;if(i==null&&(a||u))return!0;if(i==null||i===!1)return!1;if(a&&i==="clone")return i;if(typeof i=="function")return n(i(l,s,c,f),a)(l,s,c,f);var g=(a?l:s).options.group.name;return i===!0||typeof i=="string"&&i===g||i.join&&i.indexOf(g)>-1}}var o={},r=e.group;(!r||Mt(r)!="object")&&(r={name:r}),o.name=r.name,o.checkPull=n(r.pull,!0),o.checkPut=n(r.put),o.revertClone=r.revertClone,e.group=o},Rn=function(){!xn&&m&&h(m,"display","none")},Ln=function(){!xn&&m&&h(m,"display","")};Tt&&!yn&&document.addEventListener("click",function(t){if(ht)return t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.stopImmediatePropagation&&t.stopImmediatePropagation(),ht=!1,!1},!0);var ye=function(e){if(d){e=e.touches?e.touches[0]:e;var n=No(e.clientX,e.clientY);if(n){var o={};for(var r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);o.target=o.rootEl=n,o.preventDefault=void 0,o.stopPropagation=void 0,n[U]._onDragOver(o)}}},Po=function(e){d&&d.parentNode[U]._isOutsideThisEl(e.target)};function p(t,e){if(!(t&&t.nodeType&&t.nodeType===1))throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(t));this.el=t,this.options=e=ae({},e),t[U]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(t.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return On(t,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(a,l){a.setData("Text",l.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:p.supportPointer!==!1&&"PointerEvent"in window&&(!He||Gt),emptyInsertThreshold:5};et.initializePlugins(this,t,n);for(var o in n)!(o in e)&&(e[o]=n[o]);Cn(e);for(var r in this)r.charAt(0)==="_"&&typeof this[r]=="function"&&(this[r]=this[r].bind(this));this.nativeDraggable=e.forceFallback?!1:Lo,this.nativeDraggable&&(this.options.touchStartThreshold=1),e.supportPointer?w(t,"pointerdown",this._onTapStart):(w(t,"mousedown",this._onTapStart),w(t,"touchstart",this._onTapStart)),this.nativeDraggable&&(w(t,"dragover",this),w(t,"dragenter",this)),pt.push(this.el),e.store&&e.store.get&&this.sort(e.store.get(this)||[]),ae(this,Io())}p.prototype={constructor:p,_isOutsideThisEl:function(e){!this.el.contains(e)&&e!==this.el&&(Te=null)},_getDirection:function(e,n){return typeof this.options.direction=="function"?this.options.direction.call(this,e,n,d):this.options.direction},_onTapStart:function(e){if(e.cancelable){var n=this,o=this.el,r=this.options,i=r.preventOnFilter,a=e.type,l=e.touches&&e.touches[0]||e.pointerType&&e.pointerType==="touch"&&e,s=(l||e).target,c=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||s,f=r.filter;if(Xo(o),!d&&!(/mousedown|pointerdown/.test(a)&&e.button!==0||r.disabled)&&!c.isContentEditable&&!(!this.nativeDraggable&&He&&s&&s.tagName.toUpperCase()==="SELECT")&&(s=V(s,r.draggable,o,!1),!(s&&s.animated)&&lt!==s)){if(Re=H(s),ze=H(s,r.draggable),typeof f=="function"){if(f.call(this,e,s,this)){$({sortable:n,rootEl:c,name:"filter",targetEl:s,toEl:o,fromEl:o}),M("filter",n,{evt:e}),i&&e.preventDefault();return}}else if(f&&(f=f.split(",").some(function(u){if(u=V(c,u.trim(),o,!1),u)return $({sortable:n,rootEl:u,name:"filter",targetEl:s,fromEl:o,toEl:o}),M("filter",n,{evt:e}),!0}),f)){i&&e.preventDefault();return}r.handle&&!V(c,r.handle,o,!1)||this._prepareDragStart(e,l,s)}}},_prepareDragStart:function(e,n,o){var r=this,i=r.el,a=r.options,l=i.ownerDocument,s;if(o&&!d&&o.parentNode===i){var c=C(o);if(T=i,d=o,x=d.parentNode,Ee=d.nextSibling,lt=o,nt=a.group,p.dragged=d,be={target:d,clientX:(n||e).clientX,clientY:(n||e).clientY},cn=be.clientX-c.left,dn=be.clientY-c.top,this._lastX=(n||e).clientX,this._lastY=(n||e).clientY,d.style["will-change"]="all",s=function(){if(M("delayEnded",r,{evt:e}),p.eventCanceled){r._onDrop();return}r._disableDelayedDragEvents(),!rn&&r.nativeDraggable&&(d.draggable=!0),r._triggerDragStart(e,n),$({sortable:r,name:"choose",originalEvent:e}),X(d,a.chosenClass,!0)},a.ignore.split(",").forEach(function(f){Dn(d,f.trim(),At)}),w(l,"dragover",ye),w(l,"mousemove",ye),w(l,"touchmove",ye),a.supportPointer?(w(l,"pointerup",r._onDrop),!this.nativeDraggable&&w(l,"pointercancel",r._onDrop)):(w(l,"mouseup",r._onDrop),w(l,"touchend",r._onDrop),w(l,"touchcancel",r._onDrop)),rn&&this.nativeDraggable&&(this.options.touchStartThreshold=4,d.draggable=!0),M("delayStart",this,{evt:e}),a.delay&&(!a.delayOnTouchOnly||n)&&(!this.nativeDraggable||!(Qe||le))){if(p.eventCanceled){this._onDrop();return}a.supportPointer?(w(l,"pointerup",r._disableDelayedDrag),w(l,"pointercancel",r._disableDelayedDrag)):(w(l,"mouseup",r._disableDelayedDrag),w(l,"touchend",r._disableDelayedDrag),w(l,"touchcancel",r._disableDelayedDrag)),w(l,"mousemove",r._delayedDragTouchMoveHandler),w(l,"touchmove",r._delayedDragTouchMoveHandler),a.supportPointer&&w(l,"pointermove",r._delayedDragTouchMoveHandler),r._dragStartTimer=setTimeout(s,a.delay)}else s()}},_delayedDragTouchMoveHandler:function(e){var n=e.touches?e.touches[0]:e;Math.max(Math.abs(n.clientX-this._lastX),Math.abs(n.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){d&&At(d),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;y(e,"mouseup",this._disableDelayedDrag),y(e,"touchend",this._disableDelayedDrag),y(e,"touchcancel",this._disableDelayedDrag),y(e,"pointerup",this._disableDelayedDrag),y(e,"pointercancel",this._disableDelayedDrag),y(e,"mousemove",this._delayedDragTouchMoveHandler),y(e,"touchmove",this._delayedDragTouchMoveHandler),y(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,n){n=n||e.pointerType=="touch"&&e,!this.nativeDraggable||n?this.options.supportPointer?w(document,"pointermove",this._onTouchMove):n?w(document,"touchmove",this._onTouchMove):w(document,"mousemove",this._onTouchMove):(w(d,"dragend",this),w(T,"dragstart",this._onDragStart));try{document.selection?ct(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch{}},_dragStarted:function(e,n){if(Oe=!1,T&&d){M("dragStarted",this,{evt:n}),this.nativeDraggable&&w(document,"dragover",Po);var o=this.options;!e&&X(d,o.dragClass,!1),X(d,o.ghostClass,!0),p.active=this,e&&this._appendGhost(),$({sortable:this,name:"start",originalEvent:n})}else this._nulling()},_emulateDragOver:function(){if(q){this._lastX=q.clientX,this._lastY=q.clientY,Rn();for(var e=document.elementFromPoint(q.clientX,q.clientY),n=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(q.clientX,q.clientY),e!==n);)n=e;if(d.parentNode[U]._isOutsideThisEl(e),n)do{if(n[U]){var o=void 0;if(o=n[U]._onDragOver({clientX:q.clientX,clientY:q.clientY,target:e,rootEl:n}),o&&!this.options.dragoverBubble)break}e=n}while(n=En(n));Ln()}},_onTouchMove:function(e){if(be){var n=this.options,o=n.fallbackTolerance,r=n.fallbackOffset,i=e.touches?e.touches[0]:e,a=m&&Le(m,!0),l=m&&a&&a.a,s=m&&a&&a.d,c=rt&&A&&sn(A),f=(i.clientX-be.clientX+r.x)/(l||1)+(c?c[0]-Lt[0]:0)/(l||1),u=(i.clientY-be.clientY+r.y)/(s||1)+(c?c[1]-Lt[1]:0)/(s||1);if(!p.active&&!Oe){if(o&&Math.max(Math.abs(i.clientX-this._lastX),Math.abs(i.clientY-this._lastY))<o)return;this._onDragStart(e,!0)}if(m){a?(a.e+=f-(Ct||0),a.f+=u-(Rt||0)):a={a:1,b:0,c:0,d:1,e:f,f:u};var g="matrix(".concat(a.a,",").concat(a.b,",").concat(a.c,",").concat(a.d,",").concat(a.e,",").concat(a.f,")");h(m,"webkitTransform",g),h(m,"mozTransform",g),h(m,"msTransform",g),h(m,"transform",g),Ct=f,Rt=u,q=i}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!m){var e=this.options.fallbackOnBody?document.body:T,n=C(d,!0,rt,!0,e),o=this.options;if(rt){for(A=e;h(A,"position")==="static"&&h(A,"transform")==="none"&&A!==document;)A=A.parentNode;A!==document.body&&A!==document.documentElement?(A===document&&(A=Q()),n.top+=A.scrollTop,n.left+=A.scrollLeft):A=Q(),Lt=sn(A)}m=d.cloneNode(!0),X(m,o.ghostClass,!1),X(m,o.fallbackClass,!0),X(m,o.dragClass,!0),h(m,"transition",""),h(m,"transform",""),h(m,"box-sizing","border-box"),h(m,"margin",0),h(m,"top",n.top),h(m,"left",n.left),h(m,"width",n.width),h(m,"height",n.height),h(m,"opacity","0.8"),h(m,"position",rt?"absolute":"fixed"),h(m,"zIndex","100000"),h(m,"pointerEvents","none"),p.ghost=m,e.appendChild(m),h(m,"transform-origin",cn/parseInt(m.style.width)*100+"% "+dn/parseInt(m.style.height)*100+"%")}},_onDragStart:function(e,n){var o=this,r=e.dataTransfer,i=o.options;if(M("dragStart",this,{evt:e}),p.eventCanceled){this._onDrop();return}M("setupClone",this),p.eventCanceled||(I=Tn(d),I.removeAttribute("id"),I.draggable=!1,I.style["will-change"]="",this._hideClone(),X(I,this.options.chosenClass,!1),p.clone=I),o.cloneId=ct(function(){M("clone",o),!p.eventCanceled&&(o.options.removeCloneOnHide||T.insertBefore(I,d),o._hideClone(),$({sortable:o,name:"clone"}))}),!n&&X(d,i.dragClass,!0),n?(ht=!0,o._loopId=setInterval(o._emulateDragOver,50)):(y(document,"mouseup",o._onDrop),y(document,"touchend",o._onDrop),y(document,"touchcancel",o._onDrop),r&&(r.effectAllowed="move",i.setData&&i.setData.call(o,r,d)),w(document,"drop",o),h(d,"transform","translateZ(0)")),Oe=!0,o._dragStartId=ct(o._dragStarted.bind(o,n,e)),w(document,"selectstart",o),Xe=!0,window.getSelection().removeAllRanges(),He&&h(document.body,"user-select","none")},_onDragOver:function(e){var n=this.el,o=e.target,r,i,a,l=this.options,s=l.group,c=p.active,f=nt===s,u=l.sort,g=L||c,b,E=this,D=!1;if(Ut)return;function G(Me,Kn){M(Me,E,ee({evt:e,isOwner:f,axis:b?"vertical":"horizontal",revert:a,dragRect:r,targetRect:i,canSort:u,fromSortable:g,target:o,completed:P,onMove:function(Qt,Zn){return it(T,n,d,r,Qt,C(Qt),e,Zn)},changed:z},Kn))}function te(){G("dragOverAnimationCapture"),E.captureAnimationState(),E!==g&&g.captureAnimationState()}function P(Me){return G("dragOverCompleted",{insertion:Me}),Me&&(f?c._hideClone():c._showClone(E),E!==g&&(X(d,L?L.options.ghostClass:c.options.ghostClass,!1),X(d,l.ghostClass,!0)),L!==E&&E!==p.active?L=E:E===p.active&&L&&(L=null),g===E&&(E._ignoreWhileAnimating=o),E.animateAll(function(){G("dragOverAnimationComplete"),E._ignoreWhileAnimating=null}),E!==g&&(g.animateAll(),g._ignoreWhileAnimating=null)),(o===d&&!d.animated||o===n&&!o.animated)&&(Te=null),!l.dragoverBubble&&!e.rootEl&&o!==document&&(d.parentNode[U]._isOutsideThisEl(e.target),!Me&&ye(e)),!l.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),D=!0}function z(){W=H(d),ue=H(d,l.draggable),$({sortable:E,name:"change",toEl:n,newIndex:W,newDraggableIndex:ue,originalEvent:e})}if(e.preventDefault!==void 0&&e.cancelable&&e.preventDefault(),o=V(o,l.draggable,n,!0),G("dragOver"),p.eventCanceled)return D;if(d.contains(e.target)||o.animated&&o.animatingX&&o.animatingY||E._ignoreWhileAnimating===o)return P(!1);if(ht=!1,c&&!l.disabled&&(f?u||(a=x!==T):L===this||(this.lastPutMode=nt.checkPull(this,c,d,e))&&s.checkPut(this,c,d,e))){if(b=this._getDirection(e,o)==="vertical",r=C(d),G("dragOverValid"),p.eventCanceled)return D;if(a)return x=T,te(),this._hideClone(),G("revert"),p.eventCanceled||(Ee?T.insertBefore(d,Ee):T.appendChild(d)),P(!0);var k=zt(n,l.draggable);if(!k||Mo(e,b,this)&&!k.animated){if(k===d)return P(!1);if(k&&n===e.target&&(o=k),o&&(i=C(o)),it(T,n,d,r,o,i,e,!!o)!==!1)return te(),k&&k.nextSibling?n.insertBefore(d,k.nextSibling):n.appendChild(d),x=n,z(),P(!0)}else if(k&&Bo(e,b,this)){var me=Ae(n,0,l,!0);if(me===d)return P(!1);if(o=me,i=C(o),it(T,n,d,r,o,i,e,!1)!==!1)return te(),n.insertBefore(d,me),x=n,z(),P(!0)}else if(o.parentNode===n){i=C(o);var K=0,ge,Pe=d.parentNode!==n,j=!Ao(d.animated&&d.toRect||r,o.animated&&o.toRect||i,b),Fe=b?"top":"left",se=ln(o,"top","top")||ln(d,"top","top"),$e=se?se.scrollTop:void 0;Te!==o&&(ge=i[Fe],Ve=!1,ot=!j&&l.invertSwap||Pe),K=Uo(e,o,i,b,j?1:l.swapThreshold,l.invertedSwapThreshold==null?l.swapThreshold:l.invertedSwapThreshold,ot,Te===o);var ne;if(K!==0){var ve=H(d);do ve-=K,ne=x.children[ve];while(ne&&(h(ne,"display")==="none"||ne===m))}if(K===0||ne===o)return P(!1);Te=o,qe=K;var Be=o.nextElementSibling,ce=!1;ce=K===1;var tt=it(T,n,d,r,o,i,e,ce);if(tt!==!1)return(tt===1||tt===-1)&&(ce=tt===1),Ut=!0,setTimeout($o,30),te(),ce&&!Be?n.appendChild(d):o.parentNode.insertBefore(d,ce?Be:o),se&&Sn(se,0,$e-se.scrollTop),x=d.parentNode,ge!==void 0&&!ot&&(st=Math.abs(ge-C(o)[Fe])),z(),P(!0)}if(n.contains(d))return P(!1)}return!1},_ignoreWhileAnimating:null,_offMoveEvents:function(){y(document,"mousemove",this._onTouchMove),y(document,"touchmove",this._onTouchMove),y(document,"pointermove",this._onTouchMove),y(document,"dragover",ye),y(document,"mousemove",ye),y(document,"touchmove",ye)},_offUpEvents:function(){var e=this.el.ownerDocument;y(e,"mouseup",this._onDrop),y(e,"touchend",this._onDrop),y(e,"pointerup",this._onDrop),y(e,"pointercancel",this._onDrop),y(e,"touchcancel",this._onDrop),y(document,"selectstart",this)},_onDrop:function(e){var n=this.el,o=this.options;if(W=H(d),ue=H(d,o.draggable),M("drop",this,{evt:e}),x=d&&d.parentNode,W=H(d),ue=H(d,o.draggable),p.eventCanceled){this._nulling();return}Oe=!1,ot=!1,Ve=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),kt(this.cloneId),kt(this._dragStartId),this.nativeDraggable&&(y(document,"drop",this),y(n,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),He&&h(document.body,"user-select",""),h(d,"transform",""),e&&(Xe&&(e.cancelable&&e.preventDefault(),!o.dropBubble&&e.stopPropagation()),m&&m.parentNode&&m.parentNode.removeChild(m),(T===x||L&&L.lastPutMode!=="clone")&&I&&I.parentNode&&I.parentNode.removeChild(I),d&&(this.nativeDraggable&&y(d,"dragend",this),At(d),d.style["will-change"]="",Xe&&!Oe&&X(d,L?L.options.ghostClass:this.options.ghostClass,!1),X(d,this.options.chosenClass,!1),$({sortable:this,name:"unchoose",toEl:x,newIndex:null,newDraggableIndex:null,originalEvent:e}),T!==x?(W>=0&&($({rootEl:x,name:"add",toEl:x,fromEl:T,originalEvent:e}),$({sortable:this,name:"remove",toEl:x,originalEvent:e}),$({rootEl:x,name:"sort",toEl:x,fromEl:T,originalEvent:e}),$({sortable:this,name:"sort",toEl:x,originalEvent:e})),L&&L.save()):W!==Re&&W>=0&&($({sortable:this,name:"update",toEl:x,originalEvent:e}),$({sortable:this,name:"sort",toEl:x,originalEvent:e})),p.active&&((W==null||W===-1)&&(W=Re,ue=ze),$({sortable:this,name:"end",toEl:x,originalEvent:e}),this.save()))),this._nulling()},_nulling:function(){M("nulling",this),T=d=x=m=Ee=I=lt=fe=be=q=Xe=W=ue=Re=ze=Te=qe=L=nt=p.dragged=p.ghost=p.clone=p.active=null;var e=this.el;mt.forEach(function(n){e.contains(n)&&(n.checked=!0)}),mt.length=Ct=Rt=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":d&&(this._onDragOver(e),Fo(e));break;case"selectstart":e.preventDefault();break}},toArray:function(){for(var e=[],n,o=this.el.children,r=0,i=o.length,a=this.options;r<i;r++)n=o[r],V(n,a.draggable,this.el,!1)&&e.push(n.getAttribute(a.dataIdAttr)||jo(n));return e},sort:function(e,n){var o={},r=this.el;this.toArray().forEach(function(i,a){var l=r.children[a];V(l,this.options.draggable,r,!1)&&(o[i]=l)},this),n&&this.captureAnimationState(),e.forEach(function(i){o[i]&&(r.removeChild(o[i]),r.appendChild(o[i]))}),n&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,n){return V(e,n||this.options.draggable,this.el,!1)},option:function(e,n){var o=this.options;if(n===void 0)return o[e];var r=et.modifyOption(this,e,n);typeof r<"u"?o[e]=r:o[e]=n,e==="group"&&Cn(o)},destroy:function(){M("destroy",this);var e=this.el;e[U]=null,y(e,"mousedown",this._onTapStart),y(e,"touchstart",this._onTapStart),y(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(y(e,"dragover",this),y(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(n){n.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),pt.splice(pt.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!fe){if(M("hideClone",this),p.eventCanceled)return;h(I,"display","none"),this.options.removeCloneOnHide&&I.parentNode&&I.parentNode.removeChild(I),fe=!0}},_showClone:function(e){if(e.lastPutMode!=="clone"){this._hideClone();return}if(fe){if(M("showClone",this),p.eventCanceled)return;d.parentNode==T&&!this.options.group.revertClone?T.insertBefore(I,d):Ee?T.insertBefore(I,Ee):T.appendChild(I),this.options.group.revertClone&&this.animate(d,I),h(I,"display",""),fe=!1}}};function Fo(t){t.dataTransfer&&(t.dataTransfer.dropEffect="move"),t.cancelable&&t.preventDefault()}function it(t,e,n,o,r,i,a,l){var s,c=t[U],f=c.options.onMove,u;return window.CustomEvent&&!le&&!Qe?s=new CustomEvent("move",{bubbles:!0,cancelable:!0}):(s=document.createEvent("Event"),s.initEvent("move",!0,!0)),s.to=e,s.from=t,s.dragged=n,s.draggedRect=o,s.related=r||e,s.relatedRect=i||C(e),s.willInsertAfter=l,s.originalEvent=a,t.dispatchEvent(s),f&&(u=f.call(c,s,a)),u}function At(t){t.draggable=!1}function $o(){Ut=!1}function Bo(t,e,n){var o=C(Ae(n.el,0,n.options,!0)),r=In(n.el,n.options,m),i=10;return e?t.clientX<r.left-i||t.clientY<o.top&&t.clientX<o.right:t.clientY<r.top-i||t.clientY<o.bottom&&t.clientX<o.left}function Mo(t,e,n){var o=C(zt(n.el,n.options.draggable)),r=In(n.el,n.options,m),i=10;return e?t.clientX>r.right+i||t.clientY>o.bottom&&t.clientX>o.left:t.clientY>r.bottom+i||t.clientX>o.right&&t.clientY>o.top}function Uo(t,e,n,o,r,i,a,l){var s=o?t.clientY:t.clientX,c=o?n.height:n.width,f=o?n.top:n.left,u=o?n.bottom:n.right,g=!1;if(!a){if(l&&st<c*r){if(!Ve&&(qe===1?s>f+c*i/2:s<u-c*i/2)&&(Ve=!0),Ve)g=!0;else if(qe===1?s<f+st:s>u-st)return-qe}else if(s>f+c*(1-r)/2&&s<u-c*(1-r)/2)return ko(e)}return g=g||a,g&&(s<f+c*i/2||s>u-c*i/2)?s>f+c/2?1:-1:0}function ko(t){return H(d)<H(t)?1:-1}function jo(t){for(var e=t.tagName+t.className+t.src+t.href+t.textContent,n=e.length,o=0;n--;)o+=e.charCodeAt(n);return o.toString(36)}function Xo(t){mt.length=0;for(var e=t.getElementsByTagName("input"),n=e.length;n--;){var o=e[n];o.checked&&mt.push(o)}}function ct(t){return setTimeout(t,0)}function kt(t){return clearTimeout(t)}Tt&&w(document,"touchmove",function(t){(p.active||Oe)&&t.cancelable&&t.preventDefault()});p.utils={on:w,off:y,css:h,find:Dn,is:function(e,n){return!!V(e,n,e,!1)},extend:So,throttle:_n,closest:V,toggleClass:X,clone:Tn,index:H,nextTick:ct,cancelNextTick:kt,detectDirection:On,getChild:Ae,expando:U};p.get=function(t){return t[U]};p.mount=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];e[0].constructor===Array&&(e=e[0]),e.forEach(function(o){if(!o.prototype||!o.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(o));o.utils&&(p.utils=ee(ee({},p.utils),o.utils)),et.mount(o)})};p.create=function(t,e){return new p(t,e)};p.version=Do;var O=[],We,jt,Xt=!1,Nt,Pt,gt,Ye;function Wo(){function t(){this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0};for(var e in this)e.charAt(0)==="_"&&typeof this[e]=="function"&&(this[e]=this[e].bind(this))}return t.prototype={dragStarted:function(n){var o=n.originalEvent;this.sortable.nativeDraggable?w(document,"dragover",this._handleAutoScroll):this.options.supportPointer?w(document,"pointermove",this._handleFallbackAutoScroll):o.touches?w(document,"touchmove",this._handleFallbackAutoScroll):w(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(n){var o=n.originalEvent;!this.options.dragOverBubble&&!o.rootEl&&this._handleAutoScroll(o)},drop:function(){this.sortable.nativeDraggable?y(document,"dragover",this._handleAutoScroll):(y(document,"pointermove",this._handleFallbackAutoScroll),y(document,"touchmove",this._handleFallbackAutoScroll),y(document,"mousemove",this._handleFallbackAutoScroll)),fn(),dt(),To()},nulling:function(){gt=jt=We=Xt=Ye=Nt=Pt=null,O.length=0},_handleFallbackAutoScroll:function(n){this._handleAutoScroll(n,!0)},_handleAutoScroll:function(n,o){var r=this,i=(n.touches?n.touches[0]:n).clientX,a=(n.touches?n.touches[0]:n).clientY,l=document.elementFromPoint(i,a);if(gt=n,o||this.options.forceAutoScrollFallback||Qe||le||He){Ft(n,this.options,l,o);var s=pe(l,!0);Xt&&(!Ye||i!==Nt||a!==Pt)&&(Ye&&fn(),Ye=setInterval(function(){var c=pe(document.elementFromPoint(i,a),!0);c!==s&&(s=c,dt()),Ft(n,r.options,c,o)},10),Nt=i,Pt=a)}else{if(!this.options.bubbleScroll||pe(l,!0)===Q()){dt();return}Ft(n,this.options,pe(l,!1),!1)}}},ae(t,{pluginName:"scroll",initializeByDefault:!0})}function dt(){O.forEach(function(t){clearInterval(t.pid)}),O=[]}function fn(){clearInterval(Ye)}var Ft=_n(function(t,e,n,o){if(e.scroll){var r=(t.touches?t.touches[0]:t).clientX,i=(t.touches?t.touches[0]:t).clientY,a=e.scrollSensitivity,l=e.scrollSpeed,s=Q(),c=!1,f;jt!==n&&(jt=n,dt(),We=e.scroll,f=e.scrollFn,We===!0&&(We=pe(n,!0)));var u=0,g=We;do{var b=g,E=C(b),D=E.top,G=E.bottom,te=E.left,P=E.right,z=E.width,k=E.height,me=void 0,K=void 0,ge=b.scrollWidth,Pe=b.scrollHeight,j=h(b),Fe=b.scrollLeft,se=b.scrollTop;b===s?(me=z<ge&&(j.overflowX==="auto"||j.overflowX==="scroll"||j.overflowX==="visible"),K=k<Pe&&(j.overflowY==="auto"||j.overflowY==="scroll"||j.overflowY==="visible")):(me=z<ge&&(j.overflowX==="auto"||j.overflowX==="scroll"),K=k<Pe&&(j.overflowY==="auto"||j.overflowY==="scroll"));var $e=me&&(Math.abs(P-r)<=a&&Fe+z<ge)-(Math.abs(te-r)<=a&&!!Fe),ne=K&&(Math.abs(G-i)<=a&&se+k<Pe)-(Math.abs(D-i)<=a&&!!se);if(!O[u])for(var ve=0;ve<=u;ve++)O[ve]||(O[ve]={});(O[u].vx!=$e||O[u].vy!=ne||O[u].el!==b)&&(O[u].el=b,O[u].vx=$e,O[u].vy=ne,clearInterval(O[u].pid),($e!=0||ne!=0)&&(c=!0,O[u].pid=setInterval((function(){o&&this.layer===0&&p.active._onTouchMove(gt);var Be=O[this.layer].vy?O[this.layer].vy*l:0,ce=O[this.layer].vx?O[this.layer].vx*l:0;typeof f=="function"&&f.call(p.dragged.parentNode[U],ce,Be,t,gt,O[this.layer].el)!=="continue"||Sn(O[this.layer].el,ce,Be)}).bind({layer:u}),24))),u++}while(e.bubbleScroll&&g!==s&&(g=pe(g,!1)));Xt=c}},30),An=function(e){var n=e.originalEvent,o=e.putSortable,r=e.dragEl,i=e.activeSortable,a=e.dispatchSortableEvent,l=e.hideGhostForTarget,s=e.unhideGhostForTarget;if(n){var c=o||i;l();var f=n.changedTouches&&n.changedTouches.length?n.changedTouches[0]:n,u=document.elementFromPoint(f.clientX,f.clientY);s(),c&&!c.el.contains(u)&&(a("spill"),this.onSpill({dragEl:r,putSortable:o}))}};function qt(){}qt.prototype={startIndex:null,dragStart:function(e){var n=e.oldDraggableIndex;this.startIndex=n},onSpill:function(e){var n=e.dragEl,o=e.putSortable;this.sortable.captureAnimationState(),o&&o.captureAnimationState();var r=Ae(this.sortable.el,this.startIndex,this.options);r?this.sortable.el.insertBefore(n,r):this.sortable.el.appendChild(n),this.sortable.animateAll(),o&&o.animateAll()},drop:An};ae(qt,{pluginName:"revertOnSpill"});function Vt(){}Vt.prototype={onSpill:function(e){var n=e.dragEl,o=e.putSortable,r=o||this.sortable;r.captureAnimationState(),n.parentNode&&n.parentNode.removeChild(n),r.animateAll()},drop:An};ae(Vt,{pluginName:"removeOnSpill"});p.mount(new Wo);p.mount(Vt,qt);const Ne=20,Nn=3;function je(...t){const e=t.join(" ");console.log("[editor]",e);const n=document.getElementById("dbg-panel");if(n){const o=document.createElement("div");o.textContent=`[editor] ${e}`,n.appendChild(o),n.scrollTop=n.scrollHeight}}let R=[],J=null;function Yo(t){J=t;const e=document.getElementById("clip-tray");p.create(e,{animation:150,ghostClass:"sortable-ghost",filter:".tray-empty",delay:150,delayOnTouchOnly:!0,touchStartThreshold:5,onEnd(){const n=e.querySelectorAll(".clip-card"),o=[];n.forEach(r=>{const i=R.find(a=>a.id===r.dataset.id);i&&o.push(i)}),R=o,qo(),J==null||J(R)}})}function Kt(t){if(je(`addClip called: ${t.name}, clipsç¾åœ¨=${R.length}`),R.length>=Ne)return je("MAXè¶…éŽ"),!1;R.push(t),je(`clipsè¿½åŠ å¾Œ=${R.length}ã€renderTrayé–‹å§‹`);try{Fn(),je("renderTrayå®Œäº†")}catch(e){je(`renderTrayã‚¨ãƒ©ãƒ¼: ${e.message}`)}return J==null||J(R),!0}function Ho(t){var n;const e=R.find(o=>o.id===t);(n=e==null?void 0:e.thumbUrl)!=null&&n.startsWith("blob:")&&URL.revokeObjectURL(e.thumbUrl),R=R.filter(o=>o.id!==t),Fn(),J==null||J(R)}function It(){return R}function Pn(t,e){const n=R.find(i=>i.id===t);if(!n)return;n.thumbUrl=e;const o=document.querySelector(`.clip-card[data-id="${t}"]`);if(!o)return;const r=o.querySelector(".clip-thumb-img, .clip-thumb-placeholder");if(r&&e){const i=document.createElement("img");i.className="clip-thumb-img",i.src=e,i.alt="clip",r.replaceWith(i)}}function Go(){return R.length*Nn}function Fn(){const t=document.getElementById("clip-tray"),e=document.getElementById("tray-empty");if(t.querySelectorAll(".clip-card").forEach(n=>n.remove()),R.length===0){e.style.display="flex";return}e.style.display="none",R.forEach((n,o)=>{t.appendChild(zo(n,o+1))}),$n()}function zo(t,e){const n=document.createElement("div");n.className="clip-card",n.dataset.id=t.id;const o=t.thumbUrl?`<img class="clip-thumb-img" src="${t.thumbUrl}" alt="clip" />`:'<div class="clip-thumb-placeholder">ðŸŽ¬</div>';return n.innerHTML=`
    ${o}
    <span class="clip-index">${e}</span>
    <span class="clip-type-badge">${t.type==="image"?"ðŸ“·":"ðŸŽ¬"}</span>
    <button class="clip-delete" data-id="${t.id}" title="å‰Šé™¤">âœ•</button>
    <div class="clip-duration">${Nn}s</div>
  `,n.querySelector(".clip-delete").addEventListener("click",r=>{r.stopPropagation(),Ho(t.id)}),n}function qo(){document.querySelectorAll(".clip-card").forEach((e,n)=>{const o=e.querySelector(".clip-index");o&&(o.textContent=n+1)}),$n()}function $n(){const t=document.getElementById("clip-counter"),e=document.getElementById("total-duration"),n=document.getElementById("clip-count-label"),o=Go();t.textContent=`${R.length} / ${Ne}`,e.textContent=o>=60?`${Math.floor(o/60)}åˆ†${o%60>0?o%60+"ç§’":""}`:`${o}ç§’`,n.textContent=`${R.length}ã‚¯ãƒªãƒƒãƒ—`}const Vo=3e3;let Z=null,we=null,Zt="environment";async function Bn(t,e,n){await Mn(t,e,n,Zt)}async function Mn(t,e,n,o){Z&&(Z.getTracks().forEach(r=>r.stop()),Z=null);try{Z=await navigator.mediaDevices.getUserMedia({video:{facingMode:o},audio:!0}),t.srcObject=Z,Zt=o,t.style.transform=o==="user"?"scaleX(-1)":"scaleX(1)",n.disabled=!1,e&&(e.textContent="ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚æº–å‚™ãŒã§ããŸã‚‰ã€Œæ’®å½±é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚")}catch(r){throw console.error("Camera error:",r),e&&(e.textContent="ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"),n.disabled=!0,r}}async function Ko(t,e,n){await Mn(t,e,n,Zt==="environment"?"user":"environment")}function Zo(){Z&&(Z.getTracks().forEach(t=>t.stop()),Z=null)}function Jo(t,e){return new Promise((n,o)=>{if(!Z){o(new Error("Camera not initialized"));return}const r=[],i=Qo();we=new MediaRecorder(Z,i?{mimeType:i}:{}),we.ondataavailable=a=>{a.data.size>0&&r.push(a.data)},we.onstop=()=>{e.classList.remove("recording"),e.classList.add("hidden");const a=new Blob(r,{type:i||"video/webm"});n(a)},we.onerror=a=>o(a.error),e.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.classList.add("recording")})}),we.start(),setTimeout(()=>{we.state==="recording"&&we.stop()},Vo)})}function Qo(){return["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm","video/mp4"].find(e=>MediaRecorder.isTypeSupported(e))||""}function Jt(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}const Wt=document.getElementById("btn-camera"),Yt=document.getElementById("btn-upload"),hn=document.getElementById("panel-camera"),pn=document.getElementById("panel-upload"),Ke=document.getElementById("camera-preview"),er=document.getElementById("camera-placeholder"),tr=document.getElementById("record-progress"),re=document.getElementById("btn-record"),Ce=document.getElementById("btn-start-camera"),Un=document.getElementById("btn-flip-camera"),vt=document.getElementById("camera-hint"),Ie=document.getElementById("drop-zone"),kn=document.getElementById("file-input"),jn=document.getElementById("btn-preview"),Xn=document.getElementById("btn-export"),Wn=document.getElementById("processing-overlay"),bt=document.getElementById("processing-msg"),Ze=document.getElementById("processing-sub"),yt=document.getElementById("preview-modal"),wt=document.getElementById("preview-video"),nr=document.getElementById("btn-close-preview");let Je=!1,$t=!1,xe=null,Yn=!1;function N(...t){const e=t.map(r=>typeof r=="object"?JSON.stringify(r):String(r)).join(" ");console.log(e);let n=document.getElementById("dbg-panel");n||(n=document.createElement("div"),n.id="dbg-panel",n.style.cssText="position:fixed;bottom:80px;left:0;right:0;background:rgba(0,0,0,0.85);color:#0f0;font:11px monospace;padding:8px;max-height:160px;overflow-y:auto;z-index:9999;white-space:pre-wrap;",document.body.appendChild(n));const o=document.createElement("div");o.textContent=`[${new Date().toLocaleTimeString()}] ${e}`,n.appendChild(o),n.scrollTop=n.scrollHeight}async function or(){Yo(fr),rr().catch(()=>{}),Wt.addEventListener("click",()=>mn("camera")),Yt.addEventListener("click",()=>mn("upload")),Ce.addEventListener("click",ir),re.addEventListener("click",ar),Un.addEventListener("click",()=>{Ko(Ke,vt,re)}),lr(),kn.addEventListener("change",t=>{N(`change event: ${t.target.files.length}ä»¶`),Gn(Array.from(t.target.files))}),jn.addEventListener("click",hr),Xn.addEventListener("click",pr),nr.addEventListener("click",gn),yt.addEventListener("click",t=>{t.target===yt&&gn()}),document.querySelectorAll(".bgm-play").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),mr(t.dataset.track,t)})})}let Et=null;async function rr(){Et=(async()=>{try{await co(),Je=!0}catch(t){console.error("FFmpeg load error:",t)}})(),await Et}async function Hn(){if(!Je&&(Et&&await Promise.race([Et,new Promise((t,e)=>setTimeout(()=>e(new Error("timeout")),3e4))]),!Je))throw new Error("å‹•ç”»ã‚¨ãƒ³ã‚¸ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")}async function ir(){Ce.disabled=!0,Ce.textContent="èµ·å‹•ä¸­...",vt.textContent="";try{await Bn(Ke,vt,re),er.style.display="none",Ke.style.display="block",Ce.style.display="none",re.style.display="",Un.classList.remove("hidden"),Yn=!0}catch{Ce.disabled=!1,Ce.textContent="ðŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•"}}function mn(t){t==="camera"?(Wt.classList.add("active"),Yt.classList.remove("active"),hn.classList.remove("hidden"),pn.classList.add("hidden"),Yn&&Bn(Ke,vt,re)):(Yt.classList.add("active"),Wt.classList.remove("active"),pn.classList.remove("hidden"),hn.classList.add("hidden"),Zo())}async function ar(){if(!$t){if(It().length>=Ne){alert(`ã‚¯ãƒªãƒƒãƒ—ã¯æœ€å¤§${Ne}æžšã¾ã§ã§ã™ã€‚`);return}$t=!0,re.disabled=!0,re.textContent="æ’®å½±ä¸­...";try{const t=await Jo(Ke,tr);await ur(t,`camera_${Date.now()}.webm`)}catch(t){console.error("Record error:",t),alert("æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}finally{$t=!1,re.disabled=!1,re.textContent="æ’®å½±é–‹å§‹"}}}function lr(){Ie.addEventListener("dragover",t=>{t.preventDefault(),Ie.classList.add("dragover")}),Ie.addEventListener("dragleave",()=>Ie.classList.remove("dragover")),Ie.addEventListener("drop",t=>{t.preventDefault(),Ie.classList.remove("dragover"),Gn(Array.from(t.dataTransfer.files))})}async function Gn(t){N(`handleFiles: ${t.length}ä»¶`);const e=Ne-It().length;if(e<=0){alert(`ã‚¯ãƒªãƒƒãƒ—ã¯æœ€å¤§${Ne}æžšã¾ã§ã§ã™ã€‚`);return}const n=t.slice(0,e),o=[];for(const r of n){const i=sr(r);if(N(`file: ${r.name} | mime: ${r.type} | type: ${i}`),i==="video"){const a=Jt();Kt({id:a,type:"video",blob:r,thumbUrl:"",name:r.name,needsConvert:!0}),N(`å³æ™‚è¿½åŠ : ${r.name} (id=${a})`),o.push({id:a,file:r})}else i==="image"?cr(r):N(`ã‚¹ã‚­ãƒƒãƒ—: æœªå¯¾å¿œå½¢å¼ ${r.name}`)}kn.value="",o.length>0&&Promise.all(o.map(({id:r,file:i})=>zn(i).then(a=>{a&&(N(`ã‚µãƒ ãƒå–å¾—å®Œäº†: ${i.name}`),Pn(r,a))}))).catch(r=>N(`ã‚µãƒ ãƒä¸¦åˆ—å–å¾—ã‚¨ãƒ©ãƒ¼: ${r.message}`))}function sr(t){if(t.type.startsWith("video/"))return"video";if(t.type.startsWith("image/"))return"image";const e=t.name.split(".").pop().toLowerCase(),n=["mp4","mov","avi","webm","mkv","m4v","hevc","heic"],o=["jpg","jpeg","png","gif","webp","heif"];return n.includes(e)?"video":o.includes(e)?"image":null}function zn(t){return new Promise(e=>{const n=URL.createObjectURL(t),o=document.createElement("video");o.muted=!0,o.playsInline=!0,o.preload="metadata";let r=!1;const i=l=>{r||(r=!0,URL.revokeObjectURL(n),N(`ã‚µãƒ ãƒ: ${l?"OK("+l.length+"bytes)":"NG"}`),e(l))},a=()=>{try{const l=document.createElement("canvas");l.width=160,l.height=160;const s=l.getContext("2d"),c=o.videoWidth||160,f=o.videoHeight||160;N(`capture: vw=${c} vh=${f}`);const u=Math.min(c,f),g=(c-u)/2,b=(f-u)/2;s.drawImage(o,g,b,u,u,0,0,160,160),i(l.toDataURL("image/jpeg",.7))}catch(l){N(`captureå¤±æ•—: ${l.message}`),i("")}};o.onloadedmetadata=()=>{N(`loadedmetadata: duration=${o.duration}`),o.currentTime=.1},o.onseeked=()=>{N(`seeked: currentTime=${o.currentTime}`),a()},o.onloadeddata=()=>{N(`loadeddata: settled=${r}`),r||a()},o.onerror=l=>{N(`video.onerror: ${l.type}`),i("")},setTimeout(()=>{N(`ã‚µãƒ ãƒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: settled=${r}`),i("")},6e3),o.src=n,o.load()})}async function cr(t){let e="";try{e=await dr(t)}catch(n){N(`ç”»åƒã‚µãƒ ãƒã‚¨ãƒ©ãƒ¼: ${n.message}`)}Kt({id:Jt(),type:"image",blob:t,thumbUrl:e,name:t.name,isRawImage:!0})}function dr(t){return new Promise(e=>{const n=URL.createObjectURL(t),o=new Image;o.onload=()=>{try{const r=document.createElement("canvas");r.width=160,r.height=160;const i=r.getContext("2d"),a=Math.min(o.naturalWidth,o.naturalHeight),l=(o.naturalWidth-a)/2,s=(o.naturalHeight-a)/2;i.drawImage(o,l,s,a,a,0,0,160,160),e(r.toDataURL("image/jpeg",.7))}catch{e("")}finally{URL.revokeObjectURL(n)}},o.onerror=()=>{URL.revokeObjectURL(n),e("")},setTimeout(()=>{URL.revokeObjectURL(n),e("")},5e3),o.src=n})}async function ur(t,e){const n=Jt();Kt({id:n,type:"video",blob:t,thumbUrl:"",name:e,needsConvert:!0}),zn(t).then(o=>{o&&Pn(n,o)})}function fr(t){const e=t.length>0;jn.disabled=!e,Xn.disabled=!e}async function hr(){const t=It();if(t.length!==0){Je||(Dt("å‹•ç”»ã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿ä¸­...","ã‚‚ã†å°‘ã—ãŠå¾…ã¡ãã ã•ã„"),await Hn()),Dt("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­...","");try{const e=await qn(t,i=>{Ze.textContent=`${i}%`}),n=Vn(),o=await vn(e,n,i=>{Ze.textContent=`çµåˆä¸­ ${i}%`}),r=URL.createObjectURL(o);wt.src=r,_t(),yt.classList.remove("hidden"),wt.play()}catch(e){console.error("Preview error:",e),_t(),alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}}}function gn(){wt.pause(),wt.src="",yt.classList.add("hidden")}async function pr(){const t=It();if(t.length!==0){Je||(Dt("å‹•ç”»ã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿ä¸­...","ã‚‚ã†å°‘ã—ãŠå¾…ã¡ãã ã•ã„"),await Hn()),Dt("å‹•ç”»ã‚’æ›¸ãå‡ºã—ä¸­...","å°‘ã€…ãŠå¾…ã¡ãã ã•ã„");try{const e=await qn(t,a=>{Ze.textContent=`å‰å‡¦ç† ${a}%`}),n=Vn();bt.textContent="ã‚¯ãƒªãƒƒãƒ—ã‚’çµåˆä¸­...";const o=await vn(e,n,a=>{Ze.textContent=`${a}%`});_t();const r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download=`cliproll_${gr()}.mp4`,i.click(),setTimeout(()=>URL.revokeObjectURL(r),1e4)}catch(e){console.error("Export error:",e),_t(),alert("æ›¸ãå‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}}}async function qn(t,e){const n=[],o=t.filter(i=>i.isRawImage||i.needsConvert).length;let r=0;for(let i=0;i<t.length;i++){const a=t[i];if(a.isRawImage){bt.textContent=`å†™çœŸã‚’å¤‰æ›ä¸­ ${i+1} / ${t.length}`;const l=await go(a.blob);n.push(l),r++}else if(a.needsConvert){bt.textContent=`å‹•ç”»ã‚’å¤‰æ›ä¸­ ${i+1} / ${t.length}`;const l=await mo(a.blob);n.push(l),r++}else n.push(a.blob);e==null||e(o>0?Math.round(r/o*80):80)}return n}function Vn(){var e;const t=(e=document.querySelector('input[name="bgm"]:checked'))==null?void 0:e.value;return!t||t==="none"?null:`/bgm/${t}.mp3`}function mr(t,e){if(xe&&!xe.paused){xe.pause(),xe=null,document.querySelectorAll(".bgm-play").forEach(r=>r.classList.remove("playing"));return}const n=`/bgm/${t}.mp3`,o=new Audio(n);o.onerror=()=>{e.classList.remove("playing")},o.onended=()=>{e.classList.remove("playing"),xe=null},document.querySelectorAll(".bgm-play").forEach(r=>r.classList.remove("playing")),e.classList.add("playing"),xe=o,o.play().catch(()=>e.classList.remove("playing"))}function Dt(t,e){bt.textContent=t,Ze.textContent=e,Wn.classList.remove("hidden")}function _t(){Wn.classList.add("hidden")}function gr(){const t=new Date;return`${t.getFullYear()}${at(t.getMonth()+1)}${at(t.getDate())}_${at(t.getHours())}${at(t.getMinutes())}`}function at(t){return String(t).padStart(2,"0")}or();
